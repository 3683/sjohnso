#!/bin/bash

rm -f /root/anaconda-post.log 2>/dev/null
rm -f /root/build-settings 2>/dev/null
rm -rf /root/tmp 2>/dev/null

mount /dev/cdrom /mnt
cat << 'REPOS' > /etc/yum.repos.d/local.repo
[cdrom]
name=cdrom
baseurl=file:///mnt
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
gpgcheck=1
enabled=1

[Updates]
name=Updates
baseurl=http://h-yum-msn-1.binc.net/rhel/7Server/updates/rhel-7-server-rpms/
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
gpgcheck=1
enabled=1

REPOS

yum -y install python-setuptools
easy_install-2.7 pip
pip install npyscreen ipaddress
rm -f /etc/yum.repos.d/local.repo
yum clean all

cat << 'BASE64' > /tmp/base64
IyEvdXNyL2Jpbi9lbnYgcHl0aG9uCgppbXBvcnQgb3MKaW1wb3J0IHJlCmltcG9ydCBzeXMKaW1w
b3J0IGZjbnRsCmltcG9ydCBzaGxleAppbXBvcnQgc2lnbmFsCmltcG9ydCBzb2NrZXQKaW1wb3J0
IHN0cnVjdAppbXBvcnQgbnB5c2NyZWVuCmltcG9ydCBpcGFkZHJlc3MKaW1wb3J0IHN1YnByb2Nl
c3MKCiMgUHJldmVudCB1c2VyIGZyb20gdGVybWluYXRpbmcgb3Igc3RvcHBpbmcgc2NyaXB0CnNp
Z25hbC5zaWduYWwoc2lnbmFsLlNJR0lOVCwgc2lnbmFsLlNJR19JR04pCnNpZ25hbC5zaWduYWwo
c2lnbmFsLlNJR1RTVFAsIHNpZ25hbC5TSUdfSUdOKQoKZGVmIGdldF9jaWRyKG5ldG1hc2spOgog
ICAgbmV0bWFzayA9IG5ldG1hc2suc3BsaXQoJy4nKQogICAgYmluYXJ5X3N0ciA9ICcnCiAgICBm
b3Igb2N0ZXQgaW4gbmV0bWFzazoKICAgICAgICBiaW5hcnlfc3RyICs9IGJpbihpbnQob2N0ZXQp
KVsyOl0uemZpbGwoOCkKICAgIHJldHVybiBzdHIobGVuKGJpbmFyeV9zdHIucnN0cmlwKCcwJykp
KQoKZGVmIGlzX3ZhbGlkX2lwdjRfYWRkcmVzcyhhZGRyZXNzKToKICAgIHRyeToKICAgICAgICBz
b2NrZXQuaW5ldF9wdG9uKHNvY2tldC5BRl9JTkVULCBhZGRyZXNzKQogICAgZXhjZXB0IEF0dHJp
YnV0ZUVycm9yOiAgIyBubyBpbmV0X3B0b24gaGVyZSwgc29ycnkKICAgICAgICB0cnk6CiAgICAg
ICAgICAgIHNvY2tldC5pbmV0X2F0b24oYWRkcmVzcykKICAgICAgICBleGNlcHQgc29ja2V0LmVy
cm9yOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICByZXR1cm4gYWRkcmVzcy5jb3Vu
dCgnLicpID09IDMKICAgIGV4Y2VwdCBzb2NrZXQuZXJyb3I6ICAjIG5vdCBhIHZhbGlkIGFkZHJl
c3MKICAgICAgICByZXR1cm4gRmFsc2UKICAgIHJldHVybiBUcnVlCgpkZWYgZ2V0X25ldChpcCxu
ZXRtYXNrKToKICAgIGFkZHIgPSBpcGFkZHJlc3MuaXBfaW50ZXJmYWNlKHUnJXMvJXMnICUgKGlw
LG5ldG1hc2spKQogICAgcmV0dXJuIGFkZHIubmV0d29yawoKZGVmIGdldEh3QWRkcihpZm5hbWUp
OgogICAgcyA9IHNvY2tldC5zb2NrZXQoc29ja2V0LkFGX0lORVQsIHNvY2tldC5TT0NLX0RHUkFN
KQogICAgaW5mbyA9IGZjbnRsLmlvY3RsKHMuZmlsZW5vKCksIDB4ODkyNywgIHN0cnVjdC5wYWNr
KCcyNTZzJywgaWZuYW1lWzoxNV0pKQogICAgcmV0dXJuICcnLmpvaW4oWyclMDJ4OicgJSBvcmQo
Y2hhcikgZm9yIGNoYXIgaW4gaW5mb1sxODoyNF1dKVs6LTFdCgpkZWYgcnVuX2NtZChjbWQpOgog
ICAgYXJncyA9IHNobGV4LnNwbGl0KGNtZCkKICAgIHAgPSBzdWJwcm9jZXNzLlBvcGVuKGFyZ3Ms
IHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUsIHN0ZGVycj1zdWJwcm9jZXNzLlBJUEUpCiAgICAoc3Rk
b3V0LCBzdGRlcnIpID0gcC5jb21tdW5pY2F0ZSgpCiAgICByZXR1cm4gcC5yZXR1cm5jb2RlLCBz
dGRvdXQsIHN0ZGVycgoKY2xhc3MgVGVzdEFwcChucHlzY3JlZW4uTlBTQXBwKToKICAgIGRlZiBt
YWluKHNlbGYpOgogICAgICAgIEYgPSBucHlzY3JlZW4uRm9ybShuYW1lID0gIlNldCBob3N0bmFt
ZSBhbmQgSVAgaW5mb3JtYXRpb24iLCBsaW5lcz0yNCwgY29sdW1ucz04MCkKCiAgICAgICAgZnFk
biA9IEYuYWRkKG5weXNjcmVlbi5UaXRsZVRleHQsIG5hbWUgPSAiRlFETjoiLCkKICAgICAgICBp
cCA9IEYuYWRkKG5weXNjcmVlbi5UaXRsZVRleHQsIG5hbWUgPSAiSVAgQWRkcmVzczoiLCkKICAg
ICAgICBuZXRtYXNrID0gRi5hZGQobnB5c2NyZWVuLlRpdGxlVGV4dCwgbmFtZSA9ICJOZXRtYXNr
OiIsKQogICAgICAgIGdhdGV3YXkgPSBGLmFkZChucHlzY3JlZW4uVGl0bGVUZXh0LCBuYW1lID0g
IkdhdGV3YXk6IiwpCiAgICAgICAgZG5zMSA9IEYuYWRkKG5weXNjcmVlbi5UaXRsZVRleHQsIG5h
bWUgPSAiRE5TMToiLCkKICAgICAgICBkbnMyID0gRi5hZGQobnB5c2NyZWVuLlRpdGxlVGV4dCwg
bmFtZSA9ICJETlMyOiIsKQoKICAgICAgICAjIFZhbGlkYXRlIGVhY2ggdmFsdWUKICAgICAgICBn
b29kID0gRmFsc2UKICAgICAgICB3aGlsZSBnb29kID09IEZhbHNlOgogICAgICAgICAgICAjIElu
dGVyYWN0IHdpdGggZW50aXJlIGZvcm0KICAgICAgICAgICAgRi5lZGl0KCkKCiAgICAgICAgICAg
IG5ldDEgPSBnZXRfbmV0KGlwLnZhbHVlLCBuZXRtYXNrLnZhbHVlKQogICAgICAgICAgICBuZXQy
ID0gZ2V0X25ldChnYXRld2F5LnZhbHVlLCBuZXRtYXNrLnZhbHVlKQogICAgICAgICAgICBmcWRu
cGFydHMgPSByZS5zcGxpdCgnXC4nLCBmcWRuLnZhbHVlKQoKICAgICAgICAgICAgaWYgbGVuKGZx
ZG5wYXJ0cykgPD0gMToKICAgICAgICAgICAgICAgIG5weXNjcmVlbi5ub3RpZnlfY29uZmlybSgn
RVJST1I6IEZRRE4gaXMgaW52YWxpZCcpCiAgICAgICAgICAgICAgICBmcWRuLmVkaXQoKQogICAg
ICAgICAgICBlbGlmIG5vdCBpc192YWxpZF9pcHY0X2FkZHJlc3MoaXAudmFsdWUpOgogICAgICAg
ICAgICAgICAgd2hpbGUgbm90IGlzX3ZhbGlkX2lwdjRfYWRkcmVzcyhpcC52YWx1ZSk6CiAgICAg
ICAgICAgICAgICAgICAgbnB5c2NyZWVuLm5vdGlmeV9jb25maXJtKCdFUlJPUjogSW52YWxpZCBJ
UCBhZGRyZXNzIScpCiAgICAgICAgICAgICAgICAgICAgaXAuZWRpdCgpCiAgICAgICAgICAgIGVs
aWYgbm90IGlzX3ZhbGlkX2lwdjRfYWRkcmVzcyhuZXRtYXNrLnZhbHVlKToKICAgICAgICAgICAg
ICAgIHdoaWxlIG5vdCBpc192YWxpZF9pcHY0X2FkZHJlc3MobmV0bWFzay52YWx1ZSk6CiAgICAg
ICAgICAgICAgICAgICAgbnB5c2NyZWVuLm5vdGlmeV9jb25maXJtKCdFUlJPUjogSW52YWxpZCBu
ZXRtYXNrIScpCiAgICAgICAgICAgICAgICAgICAgbmV0bWFzay5lZGl0KCkKICAgICAgICAgICAg
ZWxpZiBub3QgaXNfdmFsaWRfaXB2NF9hZGRyZXNzKGdhdGV3YXkudmFsdWUpOgogICAgICAgICAg
ICAgICAgd2hpbGUgbm90IGlzX3ZhbGlkX2lwdjRfYWRkcmVzcyhnYXRld2F5LnZhbHVlKToKICAg
ICAgICAgICAgICAgICAgICBucHlzY3JlZW4ubm90aWZ5X2NvbmZpcm0oJ0VSUk9SOiBJbnZhbGlk
IGdhdGV3YXkgYWRkcmVzcyEnKQogICAgICAgICAgICAgICAgICAgIGdhdGV3YXkuZWRpdCgpCiAg
ICAgICAgICAgIGVsaWYgbm90IGlzX3ZhbGlkX2lwdjRfYWRkcmVzcyhkbnMxLnZhbHVlKToKICAg
ICAgICAgICAgICAgIHdoaWxlIG5vdCBpc192YWxpZF9pcHY0X2FkZHJlc3MoZG5zMS52YWx1ZSk6
CiAgICAgICAgICAgICAgICAgICAgbnB5c2NyZWVuLm5vdGlmeV9jb25maXJtKCdFUlJPUjogSW52
YWxpZCBETlMxIGFkZHJlc3MhJykKICAgICAgICAgICAgICAgICAgICBkbnMxLmVkaXQoKQogICAg
ICAgICAgICBlbGlmIG5vdCBpc192YWxpZF9pcHY0X2FkZHJlc3MoZG5zMi52YWx1ZSk6CiAgICAg
ICAgICAgICAgICB3aGlsZSBub3QgaXNfdmFsaWRfaXB2NF9hZGRyZXNzKGRuczIudmFsdWUpOgog
ICAgICAgICAgICAgICAgICAgIG5weXNjcmVlbi5ub3RpZnlfY29uZmlybSgnRVJST1I6IEludmFs
aWQgRE5TMiBhZGRyZXNzIScpCiAgICAgICAgICAgICAgICAgICAgZG5zMi5lZGl0KCkKICAgICAg
ICAgICAgZWxpZiBpcC52YWx1ZSA9PSBnYXRld2F5LnZhbHVlOgogICAgICAgICAgICAgICAgICAg
IG5weXNjcmVlbi5ub3RpZnlfY29uZmlybSgnRVJST1I6IElQIGFuZCBnYXRld2F5IGNhbiBub3Qg
YmUgdGhlIHNhbWUhJykKICAgICAgICAgICAgZWxpZiBuZXQxICE9IG5ldDI6CiAgICAgICAgICAg
ICAgICAgICAgbnB5c2NyZWVuLm5vdGlmeV9jb25maXJtKCdFUlJPUjogSVAgYW5kIGdhdGV3YXkg
YXJlIG5vdCBpbiB0aGUgc2FtZSBuZXR3b3JrIScpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAg
ICAgICAgICBnb29kID0gVHJ1ZQoKICAgICAgICBwcmVmaXggPSBnZXRfY2lkcihuZXRtYXNrLnZh
bHVlKQogICAgICAgIG1hYyA9IGdldEh3QWRkcignZXRoMCcpCgogICAgICAgICMgQXBwbHkgc3lz
dGVtIGNoYW5nZXMgYmFzZWQgb24gZm9ybSBkYXRhCiAgICAgICAgcnVuX2NtZCgnc3lzdGVtY3Rs
IGRpc2FibGUgc2V0LWhvc3QtaXAuc2VydmljZScpCiAgICAgICAgcnVuX2NtZCgnbm1jbGkgY29u
IG1vZCBldGgwIDgwMi0zLWV0aGVybmV0Lm1hYy1hZGRyZXNzICVzJyAlIG1hYykKICAgICAgICBy
dW5fY21kKCdob3N0bmFtZWN0bCBzZXQtaG9zdG5hbWUgJXMnICUgZnFkbi52YWx1ZSkKICAgICAg
ICBydW5fY21kKCdubWNsaSBjb24gbW9kIGV0aDAgaXB2NC5hZGRyZXNzZXMgJXMvJXMnICUgKGlw
LnZhbHVlLCBwcmVmaXgpKQogICAgICAgIHJ1bl9jbWQoJ25tY2xpIGNvbiBtb2QgZXRoMCBpcHY0
LmdhdGV3YXkgJXMnICUgZ2F0ZXdheS52YWx1ZSkKICAgICAgICBydW5fY21kKCdubWNsaSBjb24g
bW9kIGV0aDAgaXB2NC5kbnMgJXMnICUgZG5zMS52YWx1ZSkKICAgICAgICBydW5fY21kKCdubWNs
aSBjb24gbW9kIGV0aDAgK2lwdjQuZG5zICVzJyAlIGRuczIudmFsdWUpCiAgICAgICAgcnVuX2Nt
ZCgnL3Vzci9zYmluL3NodXRkb3duIC1yIG5vdycpCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18i
OgogICAgQXBwID0gVGVzdEFwcCgpCiAgICBBcHAucnVuKCkKCg==
BASE64
base64 -d /tmp/base64 > /usr/local/bin/set-host-ip.py
rm -f /tmp/base64
chmod 0700 /usr/local/bin/set-host-ip.py
chcon -u system_u -r object_r -t bin_t /usr/local/bin/set-host-ip.py

cat << 'EOM' > /etc/systemd/system/set-host-ip.service
[Unit]
Description=Run interactive program to set hostname and IP information
After=NetworkManager.service

[Service]
Environment="TERM=linux"
Environment="TERMINFO=/etc/terminfo"
ExecStart=/usr/bin/openvt -s -w -e /usr/local/bin/set-host-ip.py

[Install]
WantedBy=multi-user.target
EOM
chcon -u system_u -r object_r -t systemd_unit_file_t /etc/systemd/system/set-host-ip.service
systemctl daemon-reload
systemctl enable set-host-ip.service

sed -i 's/^\(IPADDR\).*/\1=1.1.1.2/' /etc/sysconfig/network-scripts/ifcfg-eth0
sed -i 's/^\(GATEWAY\).*/\1=1.1.1.1/' /etc/sysconfig/network-scripts/ifcfg-eth0
sed -i '/^DNS/d' /etc/sysconfig/network-scripts/ifcfg-eth0
sed -i '/^GATEWAY=/aDNS2=64.73.0.53' /etc/sysconfig/network-scripts/ifcfg-eth0
sed -i '/^GATEWAY=/aDNS1=64.73.0.21' /etc/sysconfig/network-scripts/ifcfg-eth0
sed -i '/^HWADDR/d' /etc/sysconfig/network-scripts/ifcfg-eth0
nmcli con reload
